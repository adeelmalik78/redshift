/*
Script generated by Aqua Data Studio 22.1.3 on Jul-27-2022 07:42:37 PM
Database: INFORMATION_DELIVERY_PROD
Schema: MFS_TMP
Objects: TABLE, VIEW, SEQUENCE, FUNCTION, PROCEDURE, FILE_FORMAT, STAGE, PIPE
*/
CREATE FILE FORMAT "INFORMATION_DELIVERY_PROD"."MFS_TMP"."JSON_FF"
    TYPE = JSON
    COMPRESSION = AUTO
    ENABLE_OCTAL = false
    ALLOW_DUPLICATE = false
    STRIP_OUTER_ARRAY = false
    STRIP_NULL_VALUES = false
    IGNORE_UTF8_ERRORS = false
    SKIP_BYTE_ORDER_MARK = true
    COMMENT = 'JSON File Format'
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_CLIENTSMS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/clientsms/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_CLIENT_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/client/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_COMMENTS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/comments/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_DISBURSEMENTSTATUS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/disbursementstatus/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_HISTORICPAYMENTSINSWITCHMAMBU_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/historicpaymentsinswitchmambu/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_INSWITCHTRANSACTION_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/inswitchtransaction/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_INVOICEDETAILS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/invoicedetails/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_INVOICES_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/invoices/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_LENDING_DEBITS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/lending-debits-qa/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_LENDING_INVOICE_DATA_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/lending-invoice-data/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_LENDING_LOAN_OFFERS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/lending-loan-offers/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_LENDING_PAYMENTS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/lending-payments/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_LOANFLOWSCREEN_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/loanflowscreen/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_LOAN_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/loan/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_LOGREQUESTSTOSERVICES_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/logrequeststoservices/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_ONETRUST_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/onetrust/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_PENDING_DEBITS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/pending-debits/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_PROCCESSSTATUSSCREEN_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/proccessstatusscreen/year=2022/month=07/day=27/proccessstatusscreen_20220727200000.json'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_PRODUCT_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/product/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_QUESTIONS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/questions/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_SMSTEMPLATES_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/smstemplates/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_STATUSFLOWLOAN_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/statusflowloan/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_STATUSPREAPROVED_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/statuspreaproved/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_DYNAMODB_TIGOAGENT_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/lending_dynamodb/AWSDynamoDB/tigoagent/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_MAMBU_ACTIVITIES_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/mambu/api_resources/activities/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_MAMBU_CLIENTS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/mambu/api_resources/clients/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_MAMBU_COMMUNICATIONS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/mambu/api_resources/communications/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_MAMBU_CUSTOM_FIELD_SETS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/mambu/api_resources/custom_field_sets/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_MAMBU_GL_ACCOUNTS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/mambu/api_resources/gl_accounts/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_MAMBU_GL_JOURNAL_ENTRIES_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/mambu/api_resources/gl_journal_entries/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_MAMBU_INDEX_RATE_SOURCES_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/mambu/api_resources/index_rate_sources/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_MAMBU_INSTALLMENTS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/mambu/api_resources/installments/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_MAMBU_INTEREST_ACCRUAL_BREAKDOWN_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/mambu/api_resources/interest_accrual_breakdown/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_MAMBU_LOAN_ACCOUNTS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/mambu/api_resources/loan_accounts/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_MAMBU_LOAN_PRODUCTS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/mambu/api_resources/loan_products/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_MAMBU_LOAN_REPAYMENTS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/mambu/api_resources/loan_repayments/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_MAMBU_LOAN_TRANSACTIONS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/mambu/api_resources/loan_transactions/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE STAGE "INFORMATION_DELIVERY_PROD"."MFS_TMP"."STG_MAMBU_USERS_JSON"
    file_format = ( 
    TYPE = JSON
    COMPRESSION = NONE
    )
     copy_options = (
     ON_ERROR = 'ABORT_STATEMENT'
     PURGE = false
     RETURN_FAILED_ONLY = false
     ENFORCE_LENGTH = true
     TRUNCATECOLUMNS = false
     FORCE = false
     ) 
    URL = 's3://mfs-raw-prod-us-east-1-544342739371-py/mambu/api_resources/users/'
     CREDENTIALS = ( AWS_KEY_ID = 'AKIAX5PK3BGVYYTLSHEQ' AWS_SECRET_KEY = '<your AWS secret key>')
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_CLIENTSMS_VW as (
SELECT
t.value:SMSID.S::VARCHAR AS smsid,
t.value:ClientId.S::VARCHAR AS clientid,
t.value:SmsTemplateId.S::VARCHAR AS smstemplateid,
t.value:MaxRetries.N::NUMBER AS maxretries,
t.value:CreatedDate.S::VARCHAR AS createddate,
t.value:PhoneNumber.S::VARCHAR AS phonenumber,
t.value:SmsStatus.S::VARCHAR AS smsstatus,
t.value:Retries.N::NUMBER AS retries,
t.value:SentDate.S::VARCHAR AS sentdate,
t.value:SmsResponse.S::VARCHAR AS smsresponse,
t.value:EmitterApp.S::VARCHAR AS emitterapp,
t.value:BrazeId.S::VARCHAR AS brazeid,
t.value:Params.M::VARCHAR AS params,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_clientsms_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_clientsms_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_CLIENT_VW as (
SELECT
t.value:ClientID.S::VARCHAR AS clientid,
t.value:DocumentNumber.S::VARCHAR AS documentnumber,
t.value:CivilStatus.S::VARCHAR AS civilstatus,
t.value:Sex.S::VARCHAR AS sex,
t.value:Country.S::VARCHAR AS country,
t.value:DocumentType.S::VARCHAR AS documenttype,
t.value:Msisdn.S::VARCHAR AS msisdn,
t.value:ClientIDMTS.S::NUMBER AS clientidmts,
t.value:UserPreferences.M::VARCHAR AS userpreferences,
t.value:IdCustomer.S::VARCHAR AS idcustomer,
t.value:SpouseName.S::VARCHAR AS spousename,
t.value:FirstLoginDate.S::VARCHAR AS firstlogindate,
t.value:FirstName.S::VARCHAR AS firstname,
t.value:LastName.S::VARCHAR AS lastname,
t.value:LastUpdate.S::VARCHAR AS lastupdate,
t.value:LendingDetails.L::VARCHAR AS lendingdetails,
t.value:SalaryAmount.N::NUMBER AS salaryamount,
t.value:StatusClient.S::VARCHAR AS statusclient,
t.value:Token.S::VARCHAR AS token,
t.value:AccountHolderKey.S::VARCHAR AS accountholderkey,
t.value:LastLoginDate.S::VARCHAR AS lastlogindate,
t.value:SpouseActivity.S::VARCHAR AS spouseactivity,
t.value:SessionId.S::VARCHAR AS sessionid,
t.value:tokenUsed.BOOL::BOOLEAN AS tokenused,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_client_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_client_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_COMMENTS_VW as (
SELECT
t.value:comments.N::NUMBER AS comments,
t.value:id_client.S::VARCHAR AS id_client,
t.value:another_reason.S::VARCHAR AS another_reason,
t.value:answer.S::VARCHAR AS answer,
t.value:date_poll.S::VARCHAR AS date_poll,
t.value:hour_poll.S::VARCHAR AS hour_poll,
t.value:id_country.S::VARCHAR AS id_country,
t.value:id_question.N::NUMBER AS id_question,
t.value:Local_Time_Zone.S::VARCHAR AS local_time_zone,
t.value:Local_Date.S::VARCHAR AS local_date,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_comments_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_comments_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_DISBURSEMENTSTATUS_VW as (
SELECT
t.value:DisbursementStatusID.N::NUMBER AS disbursementstatusid,
t.value:Client.S::VARCHAR AS client,
t.value:Loan.N::NUMBER AS loan,
t.value:Reversal.BOOL::BOOLEAN AS reversal,
t.value:CreatedDate.S::VARCHAR AS createddate,
t.value:Status.S::VARCHAR AS status,
t.value:ReversalStatus.S::VARCHAR AS reversalstatus,
t.value:LastUpdate.S::VARCHAR AS lastupdate,
t.value:RequestId.N::NUMBER AS requestid,
t.value:IdempotencyKey.S::VARCHAR AS idempotencykey,
t.value:RequestIdReversal.N::NUMBER AS requestidreversal,
t.value:IdempotencyKeyReversal.S::VARCHAR AS idempotencykeyreversal,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_disbursementstatus_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_disbursementstatus_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_HISTORICPAYMENTSINSWITCHMAMBU_VW as (
SELECT
t.value:HistoricPaymentsInswitchMambuID.S::VARCHAR AS historicpaymentsinswitchmambuid,
t.value:ClientidMTS.S::VARCHAR AS clientidmts,
t.value:CreatedDate.S::VARCHAR AS createddate,
t.value:InswitchTransactionID.S::VARCHAR AS inswitchtransactionid,
t.value:Msisdn.S::VARCHAR AS msisdn,
t.value:LoanAccountId.S::VARCHAR AS loanaccountid,
t.value:InswitchResponse.S::VARCHAR AS inswitchresponse,
t.value:ResponseLambdaRequest.S::VARCHAR AS responselambdarequest,
t.value:MambuResponse.S::VARCHAR AS mamburesponse,
t.value:PaymentID.S::VARCHAR AS paymentid,
t.value:ClientID.S::VARCHAR AS clientid,
t.value:MambuTransactionID.S::VARCHAR AS mambutransactionid,
t.value:LoanID.N::NUMBER AS loanid,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_historicpaymentsinswitchmambu_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_historicpaymentsinswitchmambu_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_INSWITCHTRANSACTION_VW as (
SELECT
t.value:RequestId.S::VARCHAR AS requestid,
t.value:Requester.M::VARCHAR AS requester,
t.value:CreatedDate.S::VARCHAR AS createddate,
t.value:IdempotencyKey.S::VARCHAR AS idempotencykey,
t.value:UpdatedDate.S::VARCHAR AS updateddate,
t.value:IdClient.S::VARCHAR AS idclient,
t.value:response_body.S::VARCHAR AS response_body,
t.value:LoanId.N::NUMBER AS loanid,
t.value:InswitchStatus.S::VARCHAR AS inswitchstatus,
t.value:update_date.S::VARCHAR AS update_date,
t.value:evenType.S::VARCHAR AS eventype,
t.value:StatusMambu.S::VARCHAR AS statusmambu,
t.value:transactionType.S::VARCHAR AS transactiontype,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_inswitchtransaction_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_inswitchtransaction_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_INVOICEDETAILS_VW as (
SELECT
t.value:cdc.S::VARCHAR AS cdc,
t.value:nombre.S::VARCHAR AS nombre,
t.value:condicion.S::VARCHAR AS condicion,
t.value:montoGravado10.N::NUMBER AS montogravado10,
t.value:numeroDocumento.S::VARCHAR AS numerodocumento,
t.value:puntoExpedicion.S::VARCHAR AS puntoexpedicion,
t.value:numeroIdentificacion.S::VARCHAR AS numeroidentificacion,
t.value:fechaEmision.S::VARCHAR AS fechaemision,
t.value:establecimiento.S::VARCHAR AS establecimiento,
t.value:tipoDocumento.N::NUMBER AS tipodocumento,
t.value:tipoIdentificacion.S::VARCHAR AS tipoidentificacion,
t.value:numeroTimbrado.S::VARCHAR AS numerotimbrado,
t.value:montoTotal.N::NUMBER AS montototal,
t.value:iva10.N::NUMBER AS iva10,
t.value:ivaTotal.N::NUMBER AS ivatotal,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_invoicedetails_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_invoicedetails_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_INVOICES_VW as (
SELECT
t.value:cdc.S::VARCHAR AS cdc,
t.value:establecimiento.S::VARCHAR AS establecimiento,
t.value:pdf.S::VARCHAR AS pdf,
t.value:puntoExpedicion.S::VARCHAR AS puntoexpedicion,
t.value:xml.S::VARCHAR AS xml,
t.value:documentType.N::NUMBER AS documenttype,
t.value:documentNumber.S::VARCHAR AS documentnumber,
t.value:loanAccountId.S::VARCHAR AS loanaccountid,
t.value:filepath.S::VARCHAR AS filepath,
t.value:invoiceItemsCode.N::NUMBER AS invoiceitemscode,
t.value:issueDate.S::VARCHAR AS issuedate,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_invoices_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_invoices_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_LENDING_DEBITS_VW as (
SELECT
t.value:paymentId.S::VARCHAR AS paymentid,
t.value:dueDate.S::VARCHAR AS duedate,
t.value:encodedKey.S::VARCHAR AS encodedkey,
t.value:parentAccountKey.S::VARCHAR AS parentaccountkey,
t.value:value.N::NUMBER AS value,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_lending_debits_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_lending_debits_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_LENDING_INVOICE_DATA_VW as (
SELECT
t.value:numeroFactura.N::NUMBER AS numerofactura,
t.value:b2cConContado.N::NUMBER AS b2cconcontado,
t.value:b2cConCredit.N::NUMBER AS b2cconcredit,
t.value:b2cNoConContado.N::NUMBER AS b2cnoconcontado,
t.value:b2cNoConCredit.N::NUMBER AS b2cnoconcredit,
t.value:cantidadItem.N::NUMBER AS cantidaditem,
t.value:clientEncodedKey.S::VARCHAR AS clientencodedkey,
t.value:clientID.S::VARCHAR AS clientid,
t.value:codigoIndicadorPresencia.N::NUMBER AS codigoindicadorpresencia,
t.value:codigoPais.S::VARCHAR AS codigopais,
t.value:condicionOperacion.N::NUMBER AS condicionoperacion,
t.value:createdAt.S::VARCHAR AS createdat,
t.value:creditNoteCon.N::NUMBER AS creditnotecon,
t.value:creditNoteNoCon.N::NUMBER AS creditnotenocon,
t.value:descuentoItem.N::NUMBER AS descuentoitem,
t.value:digitoVerificador.N::NUMBER AS digitoverificador,
t.value:digitoVerificadorRUCReceptor.N::NUMBER AS digitoverificadorrucreceptor,
t.value:establecimiento.S::VARCHAR AS establecimiento,
t.value:fechaHoraEmisionDE.S::VARCHAR AS fechahoraemisionde,
t.value:fileLocation.S::VARCHAR AS filelocation,
t.value:invoiceGeneralsEncodedKey.S::VARCHAR AS invoicegeneralsencodedkey,
t.value:isApprovedInvoice.N::NUMBER AS isapprovedinvoice,
t.value:isProcessInvoice.N::NUMBER AS isprocessinvoice,
t.value:isSentInvoice.N::NUMBER AS issentinvoice,
t.value:IVAOperacion.N::NUMBER AS ivaoperacion,
t.value:largeNumeroFactura.S::VARCHAR AS largenumerofactura,
t.value:lineItems.L::VARCHAR AS lineitems,
t.value:loanAccountEncodedKey.S::VARCHAR AS loanaccountencodedkey,
t.value:monedaOperacion.S::VARCHAR AS monedaoperacion,
t.value:montoTipoPago.N::NUMBER AS montotipopago,
t.value:naturalezaReceptor.N::NUMBER AS naturalezareceptor,
t.value:nombreReceptor.S::VARCHAR AS nombrereceptor,
t.value:numeroCredito.S::VARCHAR AS numerocredito,
t.value:precioUnitario.N::NUMBER AS preciounitario,
t.value:processFileName.S::VARCHAR AS processfilename,
t.value:puntoExpedicion.S::VARCHAR AS puntoexpedicion,
t.value:RUCEmisor.N::NUMBER AS rucemisor,
t.value:RUCReceptor.S::VARCHAR AS rucreceptor,
t.value:serieDocumento.N::NUMBER AS seriedocumento,
t.value:subtotalesDescuentos.N::NUMBER AS subtotalesdescuentos,
t.value:subtotalesEnviadosExe.N::NUMBER AS subtotalesenviadosexe,
t.value:subtotalesEnviadosOpe.N::NUMBER AS subtotalesenviadosope,
t.value:tasaIVA.N::NUMBER AS tasaiva,
t.value:timbrado.N::NUMBER AS timbrado,
t.value:tipoContribuyenteReceptor.N::NUMBER AS tipocontribuyentereceptor,
t.value:tipoDE.N::NUMBER AS tipode,
t.value:tipoEmision.N::NUMBER AS tipoemision,
t.value:tipoEvento.S::VARCHAR AS tipoevento,
t.value:tipoImpuestoConsumo.N::NUMBER AS tipoimpuestoconsumo,
t.value:tipoOperacion.N::NUMBER AS tipooperacion,
t.value:tipoPago.N::NUMBER AS tipopago,
t.value:tipoTransaccionEmisor.N::NUMBER AS tipotransaccionemisor,
t.value:updatedAt.S::VARCHAR AS updatedat,
t.value:xmlFileName.S::VARCHAR AS xmlfilename,
t.value:xmlRequest.S::VARCHAR AS xmlrequest,
t.value:xmlResponse.S::VARCHAR AS xmlresponse,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_lending_invoice_data_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_lending_invoice_data_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_LENDING_LOAN_OFFERS_VW as (
SELECT
t.value:clientId.S::VARCHAR AS clientid,
t.value:channel.S::VARCHAR AS channel,
t.value:cluster.N::VARCHAR AS cluster,
t.value:createAt.N::NUMBER AS createat,
t.value:expirationDate.S::VARCHAR AS expirationdate,
t.value:maxAmountGs.N::VARCHAR AS maxamountgs,
t.value:maxTermDays.N::VARCHAR AS maxtermdays,
t.value:segment.S::VARCHAR AS segment,
t.value:status.S::VARCHAR AS status,
t.value:StatusPreapproved.N::NUMBER AS statuspreapproved,
t.value:agentId.N::NUMBER AS agentid,
t.value:clientIdMTS.N::NUMBER AS clientidmts,
t.value:customerStatus.S::VARCHAR AS customerstatus,
t.value:idOffer.N::NUMBER AS idoffer,
t.value:idpdv.N::NUMBER AS idpdv,
t.value:statusApp.S::VARCHAR AS statusapp,
t.value:UploadDate.S::VARCHAR AS uploaddate,
t.value:LastUpdate.S::VARCHAR AS lastupdate,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_lending_loan_offers_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_lending_loan_offers_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_LENDING_PAYMENTS_VW as (
SELECT
t.value:ID.S::VARCHAR AS id,
t.value:ApplyInterest.BOOL::BOOLEAN AS applyinterest,
t.value:RequestId.N::VARCHAR AS requestid,
t.value:Timestamp.S::VARCHAR AS timestamp,
t.value:Country.S::VARCHAR AS country,
t.value:PaymentType.S::VARCHAR AS paymenttype,
t.value:IdempotencyKey.S::VARCHAR AS idempotencykey,
t.value:Version.S::VARCHAR AS version,
t.value:LoanAccountId.S::VARCHAR AS loanaccountid,
t.value:Amount.N::VARCHAR AS amount,
t.value:EventTypeReq.S::VARCHAR AS eventtypereq,
t.value:ValueDate.S::VARCHAR AS valuedate,
t.value:RepaymentEncodedKey.S::VARCHAR AS repaymentencodedkey,
t.value:MtsTransactionReference.S::VARCHAR AS mtstransactionreference,
t.value:lastUpdate.S::VARCHAR AS lastupdate,
t.value:IdempotencyKeyReversal.S::VARCHAR AS idempotencykeyreversal,
t.value:RequestIdReversal.N::VARCHAR AS requestidreversal,
t.value:RepaymentAdjustmentEncodedKey.S::VARCHAR AS repaymentadjustmentencodedkey,
t.value:PayloadId.S::VARCHAR AS payloadid,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_lending_payments_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_lending_payments_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_LOANFLOWSCREEN_VW as (
SELECT
t.value:LoanFlowScreenID.N::NUMBER AS loanflowscreenid,
t.value:Alias.S::VARCHAR AS alias,
t.value:ScreenDetail.S::VARCHAR AS screendetail,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_loanflowscreen_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_loanflowscreen_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_LOAN_VW as (
SELECT
t.value:LoanID.N::NUMBER AS loanid,
t.value:Client.S::VARCHAR AS client,
t.value:Balance.N::NUMBER AS balance,
t.value:Capital.N::NUMBER AS capital,
t.value:ContractURL.S::VARCHAR AS contracturl,
t.value:CreatedDate.S::VARCHAR AS createddate,
t.value:Days.N::NUMBER AS days,
t.value:Interests.N::NUMBER AS interests,
t.value:LastLoanPaymentDate.S::VARCHAR AS lastloanpaymentdate,
t.value:LastUpdate.S::VARCHAR AS lastupdate,
t.value:Latitude.S::VARCHAR AS latitude,
t.value:LoanAccountId.S::VARCHAR AS loanaccountid,
t.value:Longitude.S::VARCHAR AS longitude,
t.value:OneTrust.M::VARCHAR AS onetrust,
t.value:PeriodicityContract.S::VARCHAR AS periodicitycontract,
t.value:Requester.M::VARCHAR AS requester,
t.value:Status.S::VARCHAR AS status,
t.value:TotalAdministrativeExpenses.N::NUMBER AS totaladministrativeexpenses,
t.value:Vat.N::NUMBER AS vat,
t.value:Product.N::NUMBER AS product,
t.value:DisbursementEncodedKey.S::VARCHAR AS disbursementencodedkey,
t.value:EncodedKey.S::VARCHAR AS encodedkey,
t.value:StatusTermsConditions.M::VARCHAR AS statustermsconditions,
t.value:MtsTransactionReference.S::VARCHAR AS mtstransactionreference,
t.value:DebitAutomatic.BOOL::BOOLEAN AS debitautomatic,
t.value:RequesterReversal.M::VARCHAR AS requesterreversal,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_loan_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_loan_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_LOGREQUESTSTOSERVICES_VW as (
SELECT
t.value:ServiceRequestID.S::VARCHAR AS servicerequestid,
t.value:ServiceRequestName.S::VARCHAR AS servicerequestname,
t.value:RequestBody.S::VARCHAR AS requestbody,
t.value:FunctionName.S::VARCHAR AS functionname,
t.value:ResponseStatusCode.N::NUMBER AS responsestatuscode,
COALESCE(t.value:Headers.S, t.value:Headers.M)::VARCHAR AS headers,
t.value:CreatedDate.S::VARCHAR AS createddate,
t.value:LambdaOrLayerName.S::VARCHAR AS lambdaorlayername,
t.value:HttpTypeMethod.S::VARCHAR AS httptypemethod,
t.value:ResponseBody.S::VARCHAR AS responsebody,
t.value:Url.S::VARCHAR AS url,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_logrequeststoservices_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_logrequeststoservices_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_ONETRUST_VW as (
SELECT
t.value:OneTrustID.N::NUMBER AS onetrustid,
t.value:Client.S::VARCHAR AS client,
t.value:Status.S::VARCHAR AS status,
t.value:LastUpdate.S::VARCHAR AS lastupdate,
t.value:Local_Time_Zone.S::VARCHAR AS local_time_zone,
t.value:Local_Date.S::VARCHAR AS local_date,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_onetrust_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_onetrust_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_PENDING_DEBITS_VW as (
SELECT
t.value:loanAccountId.S::VARCHAR AS loanaccountid,
t.value:createdAtDate.S::VARCHAR AS createdatdate,
t.value:amount.S::VARCHAR AS amount,
t.value:clientId.S::VARCHAR AS clientid,
t.value:createdAtTimestamp.S::VARCHAR AS createdattimestamp,
t.value:msisdn.S::VARCHAR AS msisdn,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_pending_debits_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_pending_debits_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_PROCCESSSTATUSSCREEN_VW as (
SELECT
t.value:ProccessStatusScreenID.N::NUMBER AS proccessstatusscreenid,
t.value:StatusFlowLoanID.N::NUMBER AS statusflowloanid,
t.value:InfoScreen.S::VARCHAR AS infoscreen,
t.value:ClientID.S::VARCHAR AS clientid,
t.value:LoanID.N::NUMBER AS loanid,
t.value:LoanFlowScreenID.N::NUMBER AS loanflowscreenid,
t.value:OneTimePasswordStarted.BOOL::BOOLEAN AS onetimepasswordstarted,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_proccessstatusscreen_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_proccessstatusscreen_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
-- CREATE VIEW IF NOT EXISTS INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_PROCESSSTATUSSCREEN_TRACKING_VW AS (
-- WITH IDS AS (SELECT 
-- PROCCESSSTATUSSCREENID, MAX(LOANFLOWSCREENID) AS MAX_SCREEN
-- FROM INFORMATION_DELIVERY_PROD.MFS_LENDING.INFO_DYN_PY_PROCCESSSTATUSSCREEN
-- GROUP BY PROCCESSSTATUSSCREENID)
-- , COMB AS (
-- SELECT A.PROCCESSSTATUSSCREENID, B.LOANFLOWSCREENID, B.SCREENDETAIL
-- FROM IDS A
-- INNER JOIN INFORMATION_DELIVERY_PROD.MFS_LENDING.INFO_DYN_PY_LOANFLOWSCREEN B 
-- ON 1=1 AND B.LOANFLOWSCREENID<=A.MAX_SCREEN)
-- SELECT A.PROCCESSSTATUSSCREENID,
-- IFNULL(LAG(B.STATUSFLOWLOANID) OVER (PARTITION BY A.PROCCESSSTATUSSCREENID ORDER BY A.LOANFLOWSCREENID ASC), B.STATUSFLOWLOANID) STATUSFLOWLOANID,
-- IFNULL(LAG(B.INFOSCREEN) OVER (PARTITION BY A.PROCCESSSTATUSSCREENID ORDER BY A.LOANFLOWSCREENID ASC), B.INFOSCREEN) INFOSCREEN,
-- MAX(B.CLIENTID) OVER (PARTITION BY A.PROCCESSSTATUSSCREENID) CLIENTID,
-- IFNULL(LAG(B.LOANID) OVER (PARTITION BY A.PROCCESSSTATUSSCREENID ORDER BY A.LOANFLOWSCREENID ASC), B.LOANID) LOANID,
-- A.LOANFLOWSCREENID,
-- A.SCREENDETAIL,
-- IFNULL(LAG(B.EXTRACTION_DATE) OVER (PARTITION BY A.PROCCESSSTATUSSCREENID ORDER BY A.LOANFLOWSCREENID ASC), B.EXTRACTION_DATE) EXTRACTION_DATE
-- FROM COMB A
-- LEFT JOIN (
-- SELECT * FROM (
-- SELECT *, ROW_NUMBER() OVER (PARTITION BY PROCCESSSTATUSSCREENID,LOANFLOWSCREENID ORDER BY EXTRACTION_DATE) AS R_N 
-- FROM INFORMATION_DELIVERY_PROD.MFS_LENDING.INFO_DYN_PY_PROCCESSSTATUSSCREEN) WHERE R_N=1) B
-- ON A.PROCCESSSTATUSSCREENID=B.PROCCESSSTATUSSCREENID AND A.LOANFLOWSCREENID=B.LOANFLOWSCREENID);
-- GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_PRODUCT_VW as (
SELECT
t.value:ProductID.N::NUMBER AS productid,
t.value:Status.S::VARCHAR AS status,
t.value:AdministrativeExpense.N::NUMBER AS administrativeexpense,
t.value:Block.N::NUMBER AS block,
t.value:Country.S::VARCHAR AS country,
t.value:Description.S::VARCHAR AS description,
t.value:MaximumAmount.N::NUMBER AS maximumamount,
t.value:MaximumPeriod.N::NUMBER AS maximumperiod,
t.value:MinimumAmount.N::NUMBER AS minimumamount,
t.value:MoratoriumAnnualInterest.N::NUMBER AS moratoriumannualinterest,
t.value:OrdinaryAnnualInterest.N::NUMBER AS ordinaryannualinterest,
t.value:Periodicity.N::NUMBER AS periodicity,
t.value:Vat.N::NUMBER AS vat,
t.value:GracePeriod.N::NUMBER AS graceperiod,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_product_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_product_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_QUESTIONS_VW as (
SELECT
t.value:questions.N::NUMBER AS questions,
t.value:id_country.S::VARCHAR AS id_country,
t.value:id_question.N::NUMBER AS id_question,
t.value:question.S::VARCHAR AS question,
t.value:status.BOOL::BOOLEAN AS status,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_questions_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_questions_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_SMSTEMPLATES_VW as (
SELECT
t.value:SMSId.S::VARCHAR AS smsid,
t.value:Country.S::VARCHAR AS country,
t.value:TextMessage.S::VARCHAR AS textmessage,
t.value:Event.S::VARCHAR AS event,
t.value:EmitterApp.S::VARCHAR AS emitterapp,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_smstemplates_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_smstemplates_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_STATUSFLOWLOAN_VW as (
SELECT
t.value:StatusFlowLoanID.N::NUMBER AS statusflowloanid,
t.value:Description.S::VARCHAR AS description,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_statusflowloan_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_statusflowloan_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_STATUSPREAPROVED_VW as (
SELECT
t.value:StatusID.N::NUMBER AS statusid,
t.value:Description.S::VARCHAR AS description,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_statuspreaproved_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_statuspreaproved_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.DYN_PY_TIGOAGENT_VW as (
SELECT
t.value:AgentBusinessName.S::VARCHAR AS agentbusinessname,
t.value:AgentFantasyName.S::VARCHAR AS agentfantasyname,
t.value:AgentId.N::NUMBER AS agentid,
COALESCE(t.value:AgentMsisdn.S, t.value:AgentMsisdn.N)::VARCHAR AS agentmsisdn,
t.value:Agent_Address.S::VARCHAR AS agent_address,
t.value:Apartment.S::VARCHAR AS apartment,
t.value:City.S::VARCHAR AS city,
t.value:ClientAmount.N::NUMBER AS clientamount,
t.value:Dealer.S::VARCHAR AS dealer,
t.value:District.S::VARCHAR AS district,
t.value:FinalFlag.N::NUMBER AS finalflag,
COALESCE(t.value:FlagLotharInitial.S, t.value:FlagLotharInitial.N)::VARCHAR AS flaglotharinitial,
t.value:LatitudApp.N::NUMBER AS latitudapp,
t.value:LongitudApp.N::NUMBER AS longitudapp,
t.value:MVPMonth.S::VARCHAR AS mvpmonth,
COALESCE(t.value:OtherDealers.S, t.value:OtherDealers.N)::VARCHAR AS otherdealers,
t.value:PDVLevel.S::VARCHAR AS pdvlevel,
t.value:RankAgent.N::NUMBER AS rankagent,
t.value:AgentCode.S::VARCHAR AS agentcode,
t.value:AgentStatus.S::VARCHAR AS agentstatus,
t.value:AgentCountry.S::VARCHAR AS agentcountry,
TO_TIMESTAMP_NTZ(TO_CHAR(TRY_CAST(SUBSTR(METADATA$FILENAME,REGEXP_INSTR(METADATA$FILENAME,'.json*')-14,14) AS NUMBER)),'YYYYMMDDHH24MISS') AS EXTRACTION_DATE
FROM @stg_dynamodb_tigoagent_json S
INNER JOIN (
SELECT MAX(try_cast(substr(metadata$filename,REGEXP_INSTR(metadata$filename,'.json*')-14,14)
as NUMBER)) as max_fn
FROM @stg_dynamodb_tigoagent_json) B
ON S.metadata$filename LIKE '%' || B.max_fn|| '%',
table(flatten(S.$1)) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.MMB_ACTIVITIES_VW as (
SELECT
t.value:record.encoded_key::VARCHAR AS encoded_key,
t.value:record.timestamp::VARCHAR AS timestamp,
t.value:record.type::VARCHAR AS type,
t.value:record.notes::VARCHAR AS notes,
t.value:record.field_changes::VARCHAR AS field_changes,
t.value:record.user_name::VARCHAR AS user_name,
t.value:record.user_key::VARCHAR AS user_key,
t.value:record.client_name::VARCHAR AS client_name,
t.value:record.loan_product_name::VARCHAR AS loan_product_name,
t.value:record.loan_account_name::VARCHAR AS loan_account_name,
t.value:record.client_key::VARCHAR AS client_key,
t.value:record.transaction_id::VARCHAR AS transaction_id,
t.value:record.assigned_user_key::VARCHAR AS assigned_user_key,
t.value:record.loan_product_key::VARCHAR AS loan_product_key,
t.value:record.loan_account_key::VARCHAR AS loan_account_key,
t.value:time_extracted::TIMESTAMP_TZ(9) AS time_extracted
from @stg_mambu_activities_json S,
table(flatten(S.$1,'data')) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.MMB_CLIENTS_VW as (
SELECT
t.value:record.id::VARCHAR AS id,
t.value:record.first_name::VARCHAR AS first_name,
t.value:record.middle_name::VARCHAR AS middle_name,
t.value:record.last_name::VARCHAR AS last_name,
t.value:record.assigned_branch_key::VARCHAR AS assigned_branch_key,
t.value:record.migration_event_key::VARCHAR AS migration_event_key,
t.value:record.home_phone::VARCHAR AS home_phone,
t.value:record.mobile_phone::VARCHAR AS mobile_phone,
t.value:record.email_address::VARCHAR AS email_address,
t.value:record.preferred_language::VARCHAR AS preferred_language,
t.value:record.notes::VARCHAR AS notes,
t.value:record.gender::VARCHAR AS gender,
t.value:record.group_loan_cycle::NUMBER(38,0) AS group_loan_cycle,
t.value:record.encoded_key::VARCHAR AS encoded_key,
t.value:record.state::VARCHAR AS state,
t.value:record.assigned_user_key::VARCHAR AS assigned_user_key,
t.value:record.client_role_key::VARCHAR AS client_role_key,
t.value:record.last_modified_date::TIMESTAMP_TZ(9) AS last_modified_date,
t.value:record.creation_date::TIMESTAMP_TZ(9) AS creation_date,
t.value:record.birth_date::VARCHAR AS birth_date,
t.value:record.assigned_centre_key::VARCHAR AS assigned_centre_key,
t.value:record.approved_date::TIMESTAMP_TZ(9) AS approved_date,
t.value:record.profile_picture_key::VARCHAR AS profile_picture_key,
t.value:record.profile_signature_key::VARCHAR AS profile_signature_key,
t.value:record.activation_date::TIMESTAMP_TZ(9) AS activation_date,
t.value:record.closed_date::TIMESTAMP_TZ(9) AS closed_date,
t.value:record.addresses::VARCHAR AS addresses,
t.value:record.id_documents::VARCHAR AS id_documents,
t.value:record.custom_fields::VARCHAR AS custom_fields,
t.value:record.loan_cycle::VARCHAR AS loan_cycle,
t.value:record.custom_fields[0].field_set_id::VARCHAR AS custom_fields_field_set_id,
t.value:record.custom_fields[0].id::VARCHAR AS custom_fields_id,
t.value:record.custom_fields[0].value::VARCHAR AS custom_fields_value,
t.value:time_extracted::TIMESTAMP_TZ(9) AS time_extracted
from @stg_mambu_clients_json S,
table(flatten(S.$1,'data')) t
qualify row_number() over (partition by id order by TIME_EXTRACTED desc) = 1);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.MMB_COMMUNICATIONS_VW as (
SELECT
t.value:record.encoded_key::VARCHAR AS encoded_key,
t.value:record.template_key::VARCHAR AS template_key,
t.value:record.creation_date::VARCHAR AS creation_date,
t.value:record.send_date::VARCHAR AS send_date,
t.value:record.num_retries::VARCHAR AS num_retries,
t.value:record.type::VARCHAR AS type,
t.value:record.state::VARCHAR AS state,
t.value:record.client_key::VARCHAR AS client_key,
t.value:record.destination::VARCHAR AS destination,
t.value:record.event::VARCHAR AS event,
t.value:record.body::VARCHAR AS body,
t.value:record.custom_fields::VARCHAR AS custom_fields,
t.value:time_extracted::TIMESTAMP_TZ(9) AS time_extracted
from @stg_mambu_communications_json S,
table(flatten(S.$1,'data')) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.MMB_CUSTOM_FIELD_SETS_VW as (
SELECT
t.value:record.encoded_key::VARCHAR AS encoded_key,
t.value:record.id::VARCHAR AS id,
t.value:record.creation_date::VARCHAR AS creation_date,
t.value:record.available_for::VARCHAR AS available_for,
t.value:record.display_settings.display_name::VARCHAR AS display_settings_display_name,
t.value:time_extracted::TIMESTAMP_TZ(9) AS time_extracted
from @stg_mambu_custom_field_sets_json S,
table(flatten(S.$1,'data')) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.MMB_GL_ACCOUNTS_VW as (
SELECT
t.value:record.encoded_key::VARCHAR AS encoded_key,
t.value:record.entry_id::VARCHAR AS entry_id,
t.value:record.creation_date::TIMESTAMP_TZ(9) AS creation_date,
t.value:record.last_modified_date::TIMESTAMP_TZ(9) AS last_modified_date,
t.value:record.gl_code::VARCHAR AS gl_code,
t.value:record.type::VARCHAR AS type,
t.value:record.usage::VARCHAR AS usage,
t.value:record.name::VARCHAR AS name,
t.value:record.activated::BOOLEAN AS activated,
t.value:record.allow_manual_journal_entries::BOOLEAN AS allow_manual_journal_entries,
t.value:record.strip_trailing_zeros::BOOLEAN AS strip_trailing_zeros,
t.value:record.currency.code::VARCHAR AS currency_code,
t.value:record.currency.name::VARCHAR AS currency_name,
t.value:record.currency.symbol::VARCHAR AS currency_symbol,
t.value:record.currency.digits_after_decimal::NUMBER AS currency_digits_after_decimal,
t.value:record.currency.currency_symbol_position::VARCHAR AS currency_currency_symbol_position,
t.value:record.currency.is_base_currency::BOOLEAN AS currency_is_base_currency,
t.value:record.currency.last_modified_date::TIMESTAMP_TZ(9) AS currency_last_modified_date,
t.value:record.balance::VARCHAR AS balance,
t.value:record.currency::VARCHAR AS currency,
t.value:record.migration_event_key::VARCHAR AS migration_event_key,
t.value:time_extracted::TIMESTAMP_TZ(9) AS time_extracted
from @stg_mambu_gl_accounts_json S,
table(flatten(S.$1,'data')) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.MMB_GL_JOURNAL_ENTRIES_VW as (
SELECT
t.value:record.encoded_key::VARCHAR AS encoded_key,
t.value:record.entry_id::VARCHAR AS entry_id,
t.value:record.creation_date::TIMESTAMP_TZ(9) AS creation_date,
t.value:record.entry_date::TIMESTAMP_TZ(9) AS entry_date,
t.value:record.transaction_id::VARCHAR AS transaction_id,
t.value:record.account_key::VARCHAR AS account_key,
t.value:record.product_key::VARCHAR AS product_key,
t.value:record.amount::VARCHAR AS amount,
t.value:record.type::VARCHAR AS type,
t.value:record.user_key::VARCHAR AS user_key,
t.value:record.booking_date::TIMESTAMP_TZ(9) AS booking_date,
t.value:record.gl_account.encoded_key::VARCHAR AS gl_account_encoded_key,
t.value:record.gl_account.entry_id::VARCHAR AS gl_account_entry_id,
t.value:record.gl_account.creation_date::TIMESTAMP_TZ(9) AS gl_account_creation_date,
t.value:record.gl_account.last_modified_date::TIMESTAMP_TZ(9) AS gl_account_last_modified_date,
t.value:record.gl_account.gl_code::VARCHAR AS gl_account_gl_code,
t.value:record.gl_account.type::VARCHAR AS gl_account_type,
t.value:record.gl_account.usage::VARCHAR AS gl_account_usage,
t.value:record.gl_account.name::VARCHAR AS gl_account_name,
t.value:record.gl_account.activated::BOOLEAN AS gl_account_activated,
t.value:record.gl_account.allow_manual_journal_entries::BOOLEAN AS gl_account_allow_manual_journal_entries,
t.value:record.gl_account.strip_trailing_zeros::BOOLEAN AS gl_account_strip_trailing_zeros,
t.value:record.gl_account.currency.code::VARCHAR AS gl_account_currency_code,
t.value:record.gl_account.currency.name::VARCHAR AS gl_account_currency_name,
t.value:record.gl_account.currency.symbol::VARCHAR AS gl_account_currency_symbol,
t.value:record.gl_account.currency.digits_after_decimal::NUMBER(38,0) AS gl_account_currency_digits_after_decimal,
t.value:record.gl_account.currency.currency_symbol_position::VARCHAR AS gl_account_currency_currency_symbol_position,
t.value:record.gl_account.currency.is_base_currency::BOOLEAN AS gl_account_currency_is_base_currency,
t.value:record.gl_account.currency.last_modified_date::TIMESTAMP_TZ(9) AS gl_account_currency_last_modified_date,
t.value:record.gl_account.balance::VARCHAR AS gl_account_balance,
t.value:record.gl_account::VARCHAR AS gl_account,
t.value:record.product_type::VARCHAR AS product_type,
t.value:record.gl_account.migration_event_key::VARCHAR AS gl_account_migration_event_key,
t.value:record.reversal_entry_key::VARCHAR AS reversal_entry_key,
t.value:time_extracted::TIMESTAMP_TZ(9) AS time_extracted
from @stg_mambu_gl_journal_entries_json S,
table(flatten(S.$1,'data')) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.MMB_INDEX_RATE_SOURCES_VW as (
SELECT
t.value:record.encoded_key::VARCHAR AS encoded_key,
t.value:record.name::VARCHAR AS name,
t.value:record.notes::VARCHAR AS notes,
t.value:record.type::VARCHAR AS type,
t.value:record.id::VARCHAR AS id,
t.value:time_extracted::TIMESTAMP_TZ(9) AS time_extracted
from @stg_mambu_index_rate_sources_json S,
table(flatten(S.$1,'data')) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.MMB_INSTALLMENTS_VW as (
SELECT
t.value:record.encoded_key::VARCHAR AS encoded_key,
t.value:record.parent_account_key::VARCHAR AS parent_account_key,
t.value:record.number::VARCHAR AS number,
t.value:record.due_date::VARCHAR AS due_date,
t.value:record.last_paid_date::VARCHAR AS last_paid_date,
t.value:record.state::VARCHAR AS state,
t.value:record.is_payment_holiday::VARCHAR AS is_payment_holiday,
t.value:record.principal.amount.expected::VARCHAR AS principal_amount_expected,
t.value:record.principal.amount.paid::VARCHAR AS principal_amount_paid,
t.value:record.principal.amount.due::VARCHAR AS principal_amount_due,
t.value:record.interest.amount.expected::VARCHAR AS interest_amount_expected,
t.value:record.interest.amount.paid::VARCHAR AS interest_amount_paid,
t.value:record.interest.amount.due::VARCHAR AS interest_amount_due,
t.value:record.interest.tax.expected::VARCHAR AS interest_tax_expected,
t.value:record.interest.tax.paid::VARCHAR AS interest_tax_paid,
t.value:record.interest.tax.due::VARCHAR AS interest_tax_due,
t.value:record.fee.amount.expected::VARCHAR AS fee_amount_expected,
t.value:record.fee.amount.paid::VARCHAR AS fee_amount_paid,
t.value:record.fee.amount.due::VARCHAR AS fee_amount_due,
t.value:record.fee.tax.expected::VARCHAR AS fee_tax_expected,
t.value:record.fee.tax.paid::VARCHAR AS fee_tax_paid,
t.value:record.fee.tax.due::VARCHAR AS fee_tax_due,
t.value:record.penalty.amount.expected::VARCHAR AS penalty_amount_expected,
t.value:record.penalty.amount.paid::VARCHAR AS penalty_amount_paid,
t.value:record.penalty.amount.due::VARCHAR AS penalty_amount_due,
t.value:record.penalty.tax.expected::VARCHAR AS penalty_tax_expected,
t.value:record.penalty.tax.paid::VARCHAR AS penalty_tax_paid,
t.value:record.penalty.tax.due::VARCHAR AS penalty_tax_due,
t.value:time_extracted::TIMESTAMP_TZ(9) AS time_extracted
from @stg_mambu_installments_json S,
table(flatten(S.$1,'data')) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.MMB_INTEREST_ACCRUAL_BREAKDOWN_VW as (
SELECT
t.value:record.transaction_id::VARCHAR AS transaction_id,
t.value:record.account_key::VARCHAR AS account_key,
t.value:record.account_id::VARCHAR AS account_id,
t.value:record.product_key::VARCHAR AS product_key,
t.value:record.product_type::VARCHAR AS product_type,
t.value:record.product_id::VARCHAR AS product_id,
t.value:record.booking_date::VARCHAR AS booking_date,
t.value:record.entry_id::VARCHAR AS entry_id,
t.value:record.parent_entry_id::VARCHAR AS parent_entry_id,
t.value:record.entry_type::VARCHAR AS entry_type,
t.value:record.amount::VARCHAR AS amount,
t.value:record.creation_date::VARCHAR AS creation_date,
t.value:record.gl_account_key::VARCHAR AS gl_account_key,
t.value:record.gl_account_type::VARCHAR AS gl_account_type,
t.value:record.gl_account_name::VARCHAR AS gl_account_name,
t.value:record.gl_account_id::VARCHAR AS gl_account_id,
t.value:record.foreign_amount::VARCHAR AS foreign_amount,
t.value:time_extracted::TIMESTAMP_TZ(9) AS time_extracted
from @stg_mambu_interest_accrual_breakdown_json S,
table(flatten(S.$1,'data')) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.MMB_LOAN_ACCOUNTS_VW as (
SELECT
t.value:record.account_state::VARCHAR AS account_state,
t.value:record.currency.code::VARCHAR AS currency_code,
t.value:record.prepayment_settings.elements_recalculation_method::VARCHAR AS prepayment_settings_elements_recalculation_method,
t.value:record.prepayment_settings.principal_paid_installment_status::VARCHAR AS prepayment_settings_principal_paid_installment_status,
t.value:record.prepayment_settings.prepayment_recalculation_method::VARCHAR AS prepayment_settings_prepayment_recalculation_method,
t.value:record.prepayment_settings.apply_interest_on_prepayment_method::VARCHAR AS prepayment_settings_apply_interest_on_prepayment_method,
t.value:record.migration_event_key::VARCHAR AS migration_event_key,
t.value:record.last_set_to_arrears_date::TIMESTAMP_TZ(9) AS last_set_to_arrears_date,
t.value:record.notes::VARCHAR AS notes,
t.value:record.disbursement_details.transaction_details.encoded_key::VARCHAR AS disbursement_details_transaction_details_encoded_key,
t.value:record.disbursement_details.transaction_details.internal_transfer::BOOLEAN AS disbursement_details_transaction_details_internal_transfer,
t.value:record.disbursement_details.transaction_details.transaction_channel_key::VARCHAR AS disbursement_details_transaction_details_transaction_channel_key,
t.value:record.disbursement_details.transaction_details.transaction_channel_id::VARCHAR AS disbursement_details_transaction_details_transaction_channel_id,
t.value:record.disbursement_details.transaction_details.target_deposit_account_key::VARCHAR AS disbursement_details_transaction_details_target_deposit_account_key,
t.value:record.disbursement_details.expected_disbursement_date::TIMESTAMP_TZ(9) AS disbursement_details_expected_disbursement_date,
t.value:record.disbursement_details.first_repayment_date::TIMESTAMP_TZ(9) AS disbursement_details_first_repayment_date,
t.value:record.disbursement_details.disbursement_date::TIMESTAMP_TZ(9) AS disbursement_details_disbursement_date,
t.value:record.disbursement_details.encoded_key::VARCHAR AS disbursement_details_encoded_key,
t.value:record.days_in_arrears::NUMBER(38,0) AS days_in_arrears,
t.value:record.account_sub_state::VARCHAR AS account_sub_state,
t.value:record.loan_name::VARCHAR AS loan_name,
t.value:record.interest_settings.interest_rate_review_unit::VARCHAR AS interest_settings_interest_rate_review_unit,
t.value:record.interest_settings.interest_spread::VARCHAR AS interest_settings_interest_spread,
t.value:record.interest_settings.interest_rate::VARCHAR AS interest_settings_interest_rate,
t.value:record.interest_settings.interest_calculation_method::VARCHAR AS interest_settings_interest_calculation_method,
t.value:record.interest_settings.interest_rate_source::VARCHAR AS interest_settings_interest_rate_source,
t.value:record.interest_settings.interest_rate_review_count::NUMBER(38,0) AS interest_settings_interest_rate_review_count,
t.value:record.interest_settings.interest_application_method::VARCHAR AS interest_settings_interest_application_method,
t.value:record.interest_settings.interest_charge_frequency::VARCHAR AS interest_settings_interest_charge_frequency,
t.value:record.interest_settings.interest_type::VARCHAR AS interest_settings_interest_type,
t.value:record.interest_settings.accrue_interest_after_maturity::BOOLEAN AS interest_settings_accrue_interest_after_maturity,
t.value:record.interest_settings.interest_balance_calculation_method::VARCHAR AS interest_settings_interest_balance_calculation_method,
t.value:record.last_interest_review_date::TIMESTAMP_TZ(9) AS last_interest_review_date,
t.value:record.id::VARCHAR AS id,
t.value:record.assigned_user_key::VARCHAR AS assigned_user_key,
t.value:record.future_payments_acceptance::VARCHAR AS future_payments_acceptance,
t.value:record.accrued_interest::VARCHAR AS accrued_interest,
t.value:record.accrued_penalty::VARCHAR AS accrued_penalty,
t.value:record.creation_date::TIMESTAMP_TZ(9) AS creation_date,
t.value:record.assigned_centre_key::VARCHAR AS assigned_centre_key,
t.value:record.approved_date::TIMESTAMP_TZ(9) AS approved_date,
t.value:record.tax_rate::VARCHAR AS tax_rate,
t.value:record.last_tax_rate_review_date::TIMESTAMP_TZ(9) AS last_tax_rate_review_date,
t.value:record.interest_from_arrears_accrued::VARCHAR AS interest_from_arrears_accrued,
t.value:record.schedule_settings.grace_period::NUMBER(38,0) AS schedule_settings_grace_period,
t.value:record.schedule_settings.periodic_payment::VARCHAR AS schedule_settings_periodic_payment,
t.value:record.schedule_settings.repayment_schedule_method::VARCHAR AS schedule_settings_repayment_schedule_method,
t.value:record.schedule_settings.short_month_handling_method::VARCHAR AS schedule_settings_short_month_handling_method,
t.value:record.schedule_settings.repayment_installments::NUMBER(38,0) AS schedule_settings_repayment_installments,
t.value:record.schedule_settings.grace_period_type::VARCHAR AS schedule_settings_grace_period_type,
t.value:record.schedule_settings.principal_repayment_interval::NUMBER(38,0) AS schedule_settings_principal_repayment_interval,
t.value:record.schedule_settings.has_custom_schedule::BOOLEAN AS schedule_settings_has_custom_schedule,
t.value:record.schedule_settings.repayment_period_unit::VARCHAR AS schedule_settings_repayment_period_unit,
t.value:record.schedule_settings.schedule_due_dates_method::VARCHAR AS schedule_settings_schedule_due_dates_method,
t.value:record.schedule_settings.repayment_period_count::NUMBER(38,0) AS schedule_settings_repayment_period_count,
t.value:record.schedule_settings.default_first_repayment_due_date_offset::NUMBER(38,0) AS schedule_settings_default_first_repayment_due_date_offset,
t.value:record.days_late::NUMBER(38,0) AS days_late,
t.value:record.payment_method::VARCHAR AS payment_method,
t.value:record.account_holder_key::VARCHAR AS account_holder_key,
t.value:record.late_payments_recalculation_method::VARCHAR AS late_payments_recalculation_method,
t.value:record.account_holder_type::VARCHAR AS account_holder_type,
t.value:record.arrears_tolerance_period::NUMBER(38,0) AS arrears_tolerance_period,
t.value:record.last_interest_applied_date::TIMESTAMP_TZ(9) AS last_interest_applied_date,
t.value:record.rescheduled_account_key::VARCHAR AS rescheduled_account_key,
t.value:record.activation_transaction_key::VARCHAR AS activation_transaction_key,
t.value:record.assigned_branch_key::VARCHAR AS assigned_branch_key,
t.value:record.balances.interest_from_arrears_paid::VARCHAR AS balances_interest_from_arrears_paid,
t.value:record.balances.principal_due::VARCHAR AS balances_principal_due,
t.value:record.balances.interest_balance::VARCHAR AS balances_interest_balance,
t.value:record.balances.principal_paid::VARCHAR AS balances_principal_paid,
t.value:record.balances.penalty_due::VARCHAR AS balances_penalty_due,
t.value:record.balances.fees_balance::VARCHAR AS balances_fees_balance,
t.value:record.balances.penalty_balance::VARCHAR AS balances_penalty_balance,
t.value:record.balances.redraw_balance::VARCHAR AS balances_redraw_balance,
t.value:record.balances.interest_from_arrears_balance::VARCHAR AS balances_interest_from_arrears_balance,
t.value:record.balances.principal_balance::VARCHAR AS balances_principal_balance,
t.value:record.balances.interest_due::VARCHAR AS balances_interest_due,
t.value:record.balances.penalty_paid::VARCHAR AS balances_penalty_paid,
t.value:record.balances.fees_paid::VARCHAR AS balances_fees_paid,
t.value:record.balances.interest_from_arrears_due::VARCHAR AS balances_interest_from_arrears_due,
t.value:record.balances.fees_due::VARCHAR AS balances_fees_due,
t.value:record.balances.interest_paid::VARCHAR AS balances_interest_paid,
t.value:record.credit_arrangement_key::VARCHAR AS credit_arrangement_key,
t.value:record.interest_commission::VARCHAR AS interest_commission,
t.value:record.encoded_key::VARCHAR AS encoded_key,
t.value:record.last_appraisal_date::TIMESTAMP_TZ(9) AS last_appraisal_date,
t.value:record.last_account_appraisal_date::TIMESTAMP_TZ(9) AS last_account_appraisal_date,
t.value:record.penalty_settings.loan_penalty_calculation_method::VARCHAR AS penalty_settings_loan_penalty_calculation_method,
t.value:record.penalty_settings.penalty_rate::VARCHAR AS penalty_settings_penalty_rate,
t.value:record.settlement_account_key::VARCHAR AS settlement_account_key,
t.value:record.last_modified_date::TIMESTAMP_TZ(9) AS last_modified_date,
t.value:record.principal_payment_settings.include_interest_in_floor_amount::BOOLEAN AS principal_payment_settings_include_interest_in_floor_amount,
t.value:record.principal_payment_settings.total_due_payment::VARCHAR AS principal_payment_settings_total_due_payment,
t.value:record.principal_payment_settings.amount::VARCHAR AS principal_payment_settings_amount,
t.value:record.principal_payment_settings.principal_floor_value::VARCHAR AS principal_payment_settings_principal_floor_value,
t.value:record.principal_payment_settings.principal_payment_method::VARCHAR AS principal_payment_settings_principal_payment_method,
t.value:record.principal_payment_settings.percentage::VARCHAR AS principal_payment_settings_percentage,
t.value:record.principal_payment_settings.include_fees_in_floor_amount::BOOLEAN AS principal_payment_settings_include_fees_in_floor_amount,
t.value:record.principal_payment_settings.encoded_key::VARCHAR AS principal_payment_settings_encoded_key,
t.value:record.principal_payment_settings.total_due_amount_floor::VARCHAR AS principal_payment_settings_total_due_amount_floor,
t.value:record.principal_payment_settings.principal_ceiling_value::VARCHAR AS principal_payment_settings_principal_ceiling_value,
t.value:record.last_locked_date::TIMESTAMP_TZ(9) AS last_locked_date,
t.value:record.loan_amount::VARCHAR AS loan_amount,
t.value:record.closed_date::TIMESTAMP_TZ(9) AS closed_date,
t.value:record.product_type_key::VARCHAR AS product_type_key,
t.value:record.allow_offset::BOOLEAN AS allow_offset,
t.value:record.account_arrears_settings.monthly_tolerance_day::NUMBER(38,0) AS account_arrears_settings_monthly_tolerance_day,
t.value:record.account_arrears_settings.non_working_days_method::VARCHAR AS account_arrears_settings_non_working_days_method,
t.value:record.account_arrears_settings.tolerance_period::NUMBER(38,0) AS account_arrears_settings_tolerance_period,
t.value:record.account_arrears_settings.encoded_key::VARCHAR AS account_arrears_settings_encoded_key,
t.value:record.account_arrears_settings.tolerance_calculation_method::VARCHAR AS account_arrears_settings_tolerance_calculation_method,
t.value:record.account_arrears_settings.date_calculation_method::VARCHAR AS account_arrears_settings_date_calculation_method,
t.value:record.original_account_key::VARCHAR AS original_account_key,
t.value:record.disbursement_details.fees[0].predefined_fee_encoded_key::VARCHAR AS disbursement_details_fees_predefined_fee_encoded_key,
t.value:record.disbursement_details.fees[0].encoded_key::VARCHAR AS disbursement_details_fees_encoded_key,
t.value:record.disbursement_details.fees[0].amount::VARCHAR AS disbursement_details_fees_amount,
t.value:record.account_arrears_settings::VARCHAR AS account_arrears_settings,
t.value:record.balances::VARCHAR AS balances,
t.value:record.disbursement_details::VARCHAR AS disbursement_details,
t.value:record.prepayment_settings::VARCHAR AS prepayment_settings,
t.value:record.penalty_settings::VARCHAR AS penalty_settings,
t.value:record.schedule_settings::VARCHAR AS schedule_settings,
t.value:record.interest_settings::VARCHAR AS interest_settings,
t.value:record.assets::VARCHAR AS assets,
t.value:record.guarantors::VARCHAR AS guarantors,
t.value:record.funding_sources::VARCHAR AS funding_sources,
t.value:record.tranches::VARCHAR AS tranches,
t.value:record.currency::VARCHAR AS currency,
t.value:record.custom_fields::VARCHAR AS custom_fields,
t.value:record.balances.hold_balance::VARCHAR AS balances_hold_balance,
t.value:time_extracted::TIMESTAMP_TZ(9) AS time_extracted,
CONVERT_TIMEZONE('America/Asuncion',disbursement_details_first_repayment_date) AS local_disbursement_details_first_repayment_date,
CONVERT_TIMEZONE('America/Asuncion',creation_date) AS local_creation_date,
CONVERT_TIMEZONE('America/Asuncion',disbursement_details_disbursement_date) AS local_disbursement_details_disbursement_date,
CONVERT_TIMEZONE('America/Asuncion',disbursement_details_expected_disbursement_date) AS local_disbursement_details_expected_disbursement_date,
CONVERT_TIMEZONE('America/Asuncion',approved_date) AS local_approved_date,
CONVERT_TIMEZONE('America/Asuncion',closed_date) AS local_closed_date,
CONVERT_TIMEZONE('America/Asuncion',last_locked_date) AS local_last_locked_date
from @stg_mambu_loan_accounts_json S,
table(flatten(S.$1,'data')) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.MMB_LOAN_PRODUCTS_VW as (
SELECT
t.value:record.encoded_key::VARCHAR AS encoded_key,
t.value:record.id::VARCHAR AS id,
t.value:record.creation_date::TIMESTAMP_TZ(9) AS creation_date,
t.value:record.last_modified_date::TIMESTAMP_TZ(9) AS last_modified_date,
t.value:record.product_name::VARCHAR AS product_name,
t.value:record.product_description::VARCHAR AS product_description,
t.value:record.loan_type::VARCHAR AS loan_type,
t.value:record.loan_product_type::VARCHAR AS loan_product_type,
t.value:record.default_loan_amount::VARCHAR AS default_loan_amount,
t.value:record.max_number_of_disbursement_tranches::NUMBER(38,0) AS max_number_of_disbursement_tranches,
t.value:record.id_generator_type::VARCHAR AS id_generator_type,
t.value:record.id_pattern::VARCHAR AS id_pattern,
t.value:record.account_initial_state::VARCHAR AS account_initial_state,
t.value:record.activated::BOOLEAN AS activated,
t.value:record.repayment_schedule_method::VARCHAR AS repayment_schedule_method,
t.value:record.schedule_due_dates_method::VARCHAR AS schedule_due_dates_method,
t.value:record.default_repayment_period_count::NUMBER(38,0) AS default_repayment_period_count,
t.value:record.repayment_period_unit::VARCHAR AS repayment_period_unit,
t.value:record.default_num_installments::NUMBER(38,0) AS default_num_installments,
t.value:record.grace_period_type::VARCHAR AS grace_period_type,
t.value:record.default_principal_repayment_interval::NUMBER(38,0) AS default_principal_repayment_interval,
t.value:record.rounding_repayment_schedule_method::VARCHAR AS rounding_repayment_schedule_method,
t.value:record.repayment_currency_rounding::VARCHAR AS repayment_currency_rounding,
t.value:record.repayment_elements_rounding_method::VARCHAR AS repayment_elements_rounding_method,
t.value:record.payment_method::VARCHAR AS payment_method,
t.value:record.amortization_method::VARCHAR AS amortization_method,
t.value:record.declining_balance_prepayment_recalculation::VARCHAR AS declining_balance_prepayment_recalculation,
t.value:record.late_payments_recalculation_method::VARCHAR AS late_payments_recalculation_method,
t.value:record.prepayment_acceptance::VARCHAR AS prepayment_acceptance,
t.value:record.future_payments_acceptance::VARCHAR AS future_payments_acceptance,
t.value:record.apply_interest_on_prepayment_method::VARCHAR AS apply_interest_on_prepayment_method,
t.value:record.interest_rate_settings.encoded_key::VARCHAR AS interest_rate_settings_encoded_key,
t.value:record.interest_rate_settings.interest_charge_frequency::VARCHAR AS interest_rate_settings_interest_charge_frequency,
t.value:record.interest_rate_settings.interest_charge_frequency_count::NUMBER(38,0) AS interest_rate_settings_interest_charge_frequency_count,
t.value:record.interest_rate_settings.interest_rate_source::VARCHAR AS interest_rate_settings_interest_rate_source,
t.value:record.interest_rate_settings.interest_rate_terms::VARCHAR AS interest_rate_settings_interest_rate_terms,
t.value:record.interest_rate_settings.default_interest_rate::VARCHAR AS interest_rate_settings_default_interest_rate,
t.value:record.interest_charge_frequency::VARCHAR AS interest_charge_frequency,
t.value:record.interest_calculation_method::VARCHAR AS interest_calculation_method,
t.value:record.interest_balance_calculation_method::VARCHAR AS interest_balance_calculation_method,
t.value:record.interest_application_method::VARCHAR AS interest_application_method,
t.value:record.days_in_year::VARCHAR AS days_in_year,
t.value:record.schedule_interest_days_count_method::VARCHAR AS schedule_interest_days_count_method,
t.value:record.loan_penalty_calculation_method::VARCHAR AS loan_penalty_calculation_method,
t.value:record.arrears_date_calculation_method::VARCHAR AS arrears_date_calculation_method,
t.value:record.arrears_tolerance_period::NUMBER(38,0) AS arrears_tolerance_period,
t.value:record.allow_arbitrary_fees::BOOLEAN AS allow_arbitrary_fees,
t.value:record.accounting_method::VARCHAR AS accounting_method,
t.value:record.interest_accrued_accounting_method::VARCHAR AS interest_accrued_accounting_method,
t.value:record.account_linking_enabled::BOOLEAN AS account_linking_enabled,
t.value:record.auto_link_accounts::BOOLEAN AS auto_link_accounts,
t.value:record.auto_create_linked_accounts::BOOLEAN AS auto_create_linked_accounts,
t.value:record.settlement_options::VARCHAR AS settlement_options,
t.value:record.taxes_on_interest_enabled::BOOLEAN AS taxes_on_interest_enabled,
t.value:record.taxes_on_fees_enabled::BOOLEAN AS taxes_on_fees_enabled,
t.value:record.taxes_on_penalty_enabled::BOOLEAN AS taxes_on_penalty_enabled,
t.value:record.arrears_non_working_days_method::VARCHAR AS arrears_non_working_days_method,
t.value:record.automatically_close_dormant_accounts::BOOLEAN AS automatically_close_dormant_accounts,
t.value:record.line_of_credit_requirement::VARCHAR AS line_of_credit_requirement,
t.value:record.product_security_settings.encoded_key::VARCHAR AS product_security_settings_encoded_key,
t.value:record.product_security_settings.is_guarantors_enabled::BOOLEAN AS product_security_settings_is_guarantors_enabled,
t.value:record.product_security_settings.is_collateral_enabled::BOOLEAN AS product_security_settings_is_collateral_enabled,
t.value:record.product_security_settings.is_investor_funds_enabled::BOOLEAN AS product_security_settings_is_investor_funds_enabled,
t.value:record.product_security_settings.required_guaranties::VARCHAR AS product_security_settings_required_guaranties,
t.value:record.allow_guarantors::BOOLEAN AS allow_guarantors,
t.value:record.allow_collateral::BOOLEAN AS allow_collateral,
t.value:record.required_guaranty_percentage::VARCHAR AS required_guaranty_percentage,
t.value:record.is_investor_funds_enabled::BOOLEAN AS is_investor_funds_enabled,
t.value:record.for_individuals::BOOLEAN AS for_individuals,
t.value:record.for_pure_groups::BOOLEAN AS for_pure_groups,
t.value:record.for_hybrid_groups::BOOLEAN AS for_hybrid_groups,
t.value:record.repayment_rescheduling_method::VARCHAR AS repayment_rescheduling_method,
t.value:record.loan_fees[0].encoded_key::VARCHAR AS loan_fees_encoded_key,
t.value:record.loan_fees[0].name::VARCHAR AS loan_fees_name,
t.value:record.loan_fees[0].amount::VARCHAR AS loan_fees_amount,
t.value:record.loan_fees[0].amount_calculation_method::VARCHAR AS loan_fees_amount_calculation_method,
t.value:record.loan_fees[0].trigger::VARCHAR AS loan_fees_trigger,
t.value:record.loan_fees[0].fee_application::VARCHAR AS loan_fees_fee_application,
t.value:record.loan_fees[0].active::BOOLEAN AS loan_fees_active,
t.value:record.loan_fees[0].creation_date::TIMESTAMP_TZ(9) AS loan_fees_creation_date,
t.value:record.loan_fees[0].amoritization_profile::VARCHAR AS loan_fees_amoritization_profile,
t.value:record.loan_fees[0].amortization_interval_settings__encoded_key::VARCHAR AS loan_fees_amortization_interval_settings__encoded_key,
t.value:record.loan_fees[0].amortization_interval_settings__frequency::VARCHAR AS loan_fees_amortization_interval_settings__frequency,
t.value:record.loan_fees[0].amortization_interval_settings__period_unit::VARCHAR AS loan_fees_amortization_interval_settings__period_unit,
t.value:record.loan_fees[0].amortization_interval_settings__period_count::NUMBER(38,0) AS loan_fees_amortization_interval_settings__period_count,
t.value:record.loan_fees[0].amortization_interval_settings__interval_count::NUMBER(38,0) AS loan_fees_amortization_interval_settings__interval_count,
t.value:record.templates::VARCHAR AS templates,
t.value:record.name::VARCHAR AS name,
t.value:record.notes::VARCHAR AS notes,
t.value:record.type::VARCHAR AS type,
t.value:record.category::VARCHAR AS category,
t.value:record.state::VARCHAR AS state,
t.value:record.loan_amount_settings.loan_amount.min_value::VARCHAR AS loan_amount_settings_loan_amount_min_value,
t.value:record.loan_amount_settings.loan_amount.max_value::VARCHAR AS loan_amount_settings_loan_amount_max_value,
t.value:record.schedule_settings.repayment_schedule_method::VARCHAR AS schedule_settings_repayment_schedule_method,
t.value:record.schedule_settings.schedule_due_dates_method::VARCHAR AS schedule_settings_schedule_due_dates_method,
t.value:record.schedule_settings.repayment_period_unit::VARCHAR AS schedule_settings_repayment_period_unit,
t.value:record.schedule_settings.rounding_settings.rounding_repayment_schedule_method::VARCHAR AS schedule_settings_rounding_settings_rounding_repayment_schedule_method,
t.value:record.schedule_settings.rounding_settings.repayment_currency_rounding::VARCHAR AS schedule_settings_rounding_settings_repayment_currency_rounding,
t.value:record.schedule_settings.rounding_settings.repayment_elements_rounding_method::VARCHAR AS schedule_settings_rounding_settings_repayment_elements_rounding_method,
t.value:record.schedule_settings.repayment_rescheduling_method::VARCHAR AS schedule_settings_repayment_rescheduling_method,
t.value:record.payment_settings.payment_method::VARCHAR AS payment_settings_payment_method,
t.value:record.payment_settings.amortization_method::VARCHAR AS payment_settings_amortization_method,
t.value:record.payment_settings.prepayment_settings.prepayment_recalculation_method::VARCHAR AS payment_settings_prepayment_settings_prepayment_recalculation_method,
t.value:record.payment_settings.prepayment_settings.prepayment_acceptance::VARCHAR AS payment_settings_prepayment_settings_prepayment_acceptance,
t.value:record.payment_settings.prepayment_settings.future_payments_acceptance::VARCHAR AS payment_settings_prepayment_settings_future_payments_acceptance,
t.value:record.payment_settings.prepayment_settings.apply_interest_on_prepayment_method::VARCHAR AS payment_settings_prepayment_settings_apply_interest_on_prepayment_method,
t.value:record.payment_settings.prepayment_settings.principal_paid_installment_status::VARCHAR AS payment_settings_prepayment_settings_principal_paid_installment_status,
t.value:record.payment_settings.late_payments_recalculation_method::VARCHAR AS payment_settings_late_payments_recalculation_method,
t.value:record.payment_settings.repayment_allocation_order[0].FEE::VARCHAR AS payment_settings_repayment_allocation_order_fee,
t.value:record.payment_settings.repayment_allocation_order[1].PENALTY::VARCHAR AS payment_settings_repayment_allocation_order_penalty,
t.value:record.payment_settings.repayment_allocation_order[2].INTEREST::VARCHAR AS payment_settings_repayment_allocation_order_interest,
t.value:record.payment_settings.repayment_allocation_order[3].PRINCIPAL::VARCHAR AS payment_settings_repayment_allocation_order_principal,
t.value:record.grace_period_settings.grace_period_type::VARCHAR AS grace_period_settings_grace_period_type,
t.value:record.new_account_settings.id_generator_type::VARCHAR AS new_account_settings_id_generator_type,
t.value:record.new_account_settings.id_pattern::VARCHAR AS new_account_settings_id_pattern,
t.value:record.new_account_settings.account_initial_state::VARCHAR AS new_account_settings_account_initial_state,
t.value:record.interest_settings.interest_application_method::VARCHAR AS interest_settings_interest_application_method,
t.value:record.interest_settings.interest_balance_calculation_method::VARCHAR AS interest_settings_interest_balance_calculation_method,
t.value:record.interest_settings.interest_calculation_method::VARCHAR AS interest_settings_interest_calculation_method,
t.value:record.interest_settings.days_in_year::VARCHAR AS interest_settings_days_in_year,
t.value:record.interest_settings.schedule_interest_days_count_method::VARCHAR AS interest_settings_schedule_interest_days_count_method,
t.value:record.interest_settings.interest_type::VARCHAR AS interest_settings_interest_type,
t.value:record.interest_settings.index_rate_settings.interest_rate_source::VARCHAR AS interest_settings_index_rate_settings_interest_rate_source,
t.value:record.interest_settings.index_rate_settings.interest_rate_terms::VARCHAR AS interest_settings_index_rate_settings_interest_rate_terms,
t.value:record.interest_settings.index_rate_settings.interest_charge_frequency::VARCHAR AS interest_settings_index_rate_settings_interest_charge_frequency,
t.value:record.interest_settings.index_rate_settings.encoded_key::VARCHAR AS interest_settings_index_rate_settings_encoded_key,
t.value:record.penalty_settings.loan_penalty_calculation_method::VARCHAR AS penalty_settings_loan_penalty_calculation_method,
t.value:record.arrears_settings.encoded_key::VARCHAR AS arrears_settings_encoded_key,
t.value:record.arrears_settings.tolerance_calculation_method::VARCHAR AS arrears_settings_tolerance_calculation_method,
t.value:record.arrears_settings.date_calculation_method::VARCHAR AS arrears_settings_date_calculation_method,
t.value:record.arrears_settings.non_working_days_method::VARCHAR AS arrears_settings_non_working_days_method,
t.value:record.fees_settings.fees[0].encoded_key::VARCHAR AS fees_settings_fees_encoded_key,
t.value:record.fees_settings.fees[0].name::VARCHAR AS fees_settings_fees_name,
t.value:record.fees_settings.fees[0].id::VARCHAR AS fees_settings_fees_id,
t.value:record.fees_settings.fees[0].amount_calculation_method::VARCHAR AS fees_settings_fees_amount_calculation_method,
t.value:record.fees_settings.fees[0].trigger::VARCHAR AS fees_settings_fees_trigger,
t.value:record.fees_settings.fees[0].fee_application::VARCHAR AS fees_settings_fees_fee_application,
t.value:record.fees_settings.fees[0].state::VARCHAR AS fees_settings_fees_state,
t.value:record.fees_settings.fees[0].creation_date::VARCHAR AS fees_settings_fees_creation_date,
t.value:record.fees_settings.fees[0].last_modified_date::VARCHAR AS fees_settings_fees_last_modified_date,
t.value:record.fees_settings.fees[0].percentage_amount::VARCHAR AS fees_settings_fees_percentage_amount,
t.value:record.fees_settings.fees[0].amortization_settings.amortization_profile::VARCHAR AS fees_settings_fees_amortization_settings_amortization_profile,
t.value:record.fees_settings.fees[0].amortization_settings.fee_amortization_upon_reschedule_refinance_option::VARCHAR AS fees_settings_fees_amortization_settings_fee_amortization_upon_reschedule_refinance_option,
t.value:record.fees_settings.fees[0].tax_settings.taxable_calculation_method::VARCHAR AS fees_settings_fees_tax_settings_taxable_calculation_method,
t.value:record.accounting_settings.accounting_method::VARCHAR AS accounting_settings_accounting_method,
t.value:record.accounting_settings.interest_accrued_accounting_method::VARCHAR AS accounting_settings_interest_accrued_accounting_method,
t.value:record.accounting_settings.interest_accrual_calculation::VARCHAR AS accounting_settings_interest_accrual_calculation,
t.value:record.accounting_settings.accounting_rules[0].encoded_key::VARCHAR AS accounting_settings_accounting_rules_encoded_key,
t.value:record.accounting_settings.accounting_rules[0].gl_account_key::VARCHAR AS accounting_settings_accounting_rules_gl_account_key,
t.value:record.accounting_settings.accounting_rules[0].financial_resource::VARCHAR AS accounting_settings_accounting_rules_financial_resource,
t.value:record.account_link_settings.settlement_method::VARCHAR AS account_link_settings_settlement_method,
t.value:record.tax_settings.tax_source_key::VARCHAR AS tax_settings_tax_source_key,
t.value:record.tax_settings.tax_calculation_method::VARCHAR AS tax_settings_tax_calculation_method,
t.value:record.credit_arrangement_settings.credit_arrangement_requirement::VARCHAR AS credit_arrangement_settings_credit_arrangement_requirement,
t.value:record.availability_settings.available_for[0].INDIVIDUALS::VARCHAR AS availability_settings_available_for_individuals,
t.value:record.allow_custom_repayment_allocation::VARCHAR AS allow_custom_repayment_allocation,
t.value:record.currency.code::VARCHAR AS currency_code,
t.value:time_extracted::TIMESTAMP_TZ(9) AS time_extracted
from @stg_mambu_loan_products_json S,
table(flatten(S.$1,'data')) t
qualify row_number() over (partition by encoded_key order by TIME_EXTRACTED desc) = 1);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.MMB_LOAN_REPAYMENTS_VW as (
SELECT
t.value:record.encoded_key::VARCHAR AS encoded_key,
t.value:record.parent_account_key::VARCHAR AS parent_account_key,
t.value:record.due_date::TIMESTAMP_TZ(9) AS due_date,
t.value:record.principal_due::VARCHAR AS principal_due,
t.value:record.principal_paid::VARCHAR AS principal_paid,
t.value:record.interest_due::VARCHAR AS interest_due,
t.value:record.interest_paid::VARCHAR AS interest_paid,
t.value:record.fees_due::VARCHAR AS fees_due,
t.value:record.fees_paid::VARCHAR AS fees_paid,
t.value:record.penalty_due::VARCHAR AS penalty_due,
t.value:record.penalty_paid::VARCHAR AS penalty_paid,
t.value:record.state::VARCHAR AS state,
t.value:record.tax_interest_due::VARCHAR AS tax_interest_due,
t.value:record.tax_interest_paid::VARCHAR AS tax_interest_paid,
t.value:record.tax_fees_due::VARCHAR AS tax_fees_due,
t.value:record.tax_fees_paid::VARCHAR AS tax_fees_paid,
t.value:record.tax_penalty_due::VARCHAR AS tax_penalty_due,
t.value:record.tax_penalty_paid::VARCHAR AS tax_penalty_paid,
t.value:record.repaid_date::VARCHAR AS repaid_date,
t.value:record.last_paid_date::VARCHAR AS last_paid_date,
t.value:time_extracted::TIMESTAMP_TZ(9) AS time_extracted
from @stg_mambu_loan_repayments_json S,
table(flatten(S.$1,'data')) t);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.MMB_LOAN_TRANSACTIONS_VW as (
SELECT LT.*, ADJ.ADJUSTMENT_TRANSACTION_ID, ORI.ORIGINAL_TRANSACTION_ID
FROM (
SELECT
t.value:record.encoded_key::VARCHAR AS encoded_key,
t.value:record.parent_account_key::VARCHAR AS parent_account_key,
t.value:record.due_date::TIMESTAMP_TZ(9) AS due_date,
t.value:record.principal_due::VARCHAR AS principal_due,
t.value:record.principal_paid::VARCHAR AS principal_paid,
t.value:record.interest_due::VARCHAR AS interest_due,
t.value:record.interest_paid::VARCHAR AS interest_paid,
t.value:record.fees_due::VARCHAR AS fees_due,
t.value:record.fees_paid::VARCHAR AS fees_paid,
t.value:record.penalty_due::VARCHAR AS penalty_due,
t.value:record.penalty_paid::VARCHAR AS penalty_paid,
t.value:record.state::VARCHAR AS state,
t.value:record.tax.interest_due::VARCHAR AS tax_interest_due,
t.value:record.tax.interest_paid::VARCHAR AS tax_interest_paid,
t.value:record.tax.fees_due::VARCHAR AS tax_fees_due,
t.value:record.tax.fees_paid::VARCHAR AS tax_fees_paid,
t.value:record.tax.penalty_due::VARCHAR AS tax_penalty_due,
t.value:record.tax.penalty_paid::VARCHAR AS tax_penalty_paid,
t.value:record.type::VARCHAR AS type,
t.value:record.id::VARCHAR AS id,
t.value:record.creation_date::VARCHAR AS creation_date,
t.value:record.value_date::VARCHAR AS value_date,
t.value:record.booking_date::VARCHAR AS booking_date,
t.value:record.amount::VARCHAR AS amount,
t.value:record.affected_amounts::VARCHAR AS affected_amounts,
t.value:record.taxes::VARCHAR AS taxes,
t.value:record.account_balances::VARCHAR AS account_balances,
t.value:record.terms::VARCHAR AS terms,
t.value:record.transaction_details::VARCHAR AS transaction_details,
t.value:record.fees::VARCHAR AS fees,
t.value:record.currency::VARCHAR AS currency,
t.value:record.custom_fields::VARCHAR AS custom_fields,
t.value:record.notes::VARCHAR AS notes,
t.value:record.user_key::VARCHAR AS user_key,
t.value:record.affected_amounts.principal_amount::VARCHAR AS affected_amounts_principal_amount,
t.value:record.affected_amounts.interest_amount::VARCHAR AS affected_amounts_interest_amount,
t.value:record.affected_amounts.interest_from_arrears_amount::VARCHAR AS affected_amounts_interest_from_arrears_amount,
t.value:record.affected_amounts.deferred_interest_amount::VARCHAR AS affected_amounts_deferred_interest_amount,
t.value:record.affected_amounts.fees_amount::VARCHAR AS affected_amounts_fees_amount,
t.value:record.affected_amounts.penalty_amount::VARCHAR AS affected_amounts_penalty_amount,
t.value:record.affected_amounts.funders_interest_amount::VARCHAR AS affected_amounts_funders_interest_amount,
t.value:record.affected_amounts.organization_commission_amount::VARCHAR AS affected_amounts_organization_commission_amount,
t.value:record.taxes.tax_on_interest_amount::VARCHAR AS taxes_tax_on_interest_amount,
t.value:record.taxes.tax_on_interest_from_arrears_amount::VARCHAR AS taxes_tax_on_interest_from_arrears_amount,
t.value:record.taxes.deferred_tax_on_interest_amount::VARCHAR AS taxes_deferred_tax_on_interest_amount,
t.value:record.taxes.tax_on_fees_amount::VARCHAR AS taxes_tax_on_fees_amount,
t.value:record.taxes.tax_on_penalty_amount::VARCHAR AS taxes_tax_on_penalty_amount,
t.value:record.taxes.tax_rate::VARCHAR AS taxes_tax_rate,
t.value:record.account_balances.total_balance::VARCHAR AS account_balances_total_balance,
t.value:record.account_balances.advance_position::VARCHAR AS account_balances_advance_position,
t.value:record.account_balances.arrears_position::VARCHAR AS account_balances_arrears_position,
t.value:record.account_balances.expected_principal_redraw::VARCHAR AS account_balances_expected_principal_redraw,
t.value:record.account_balances.redraw_balance::VARCHAR AS account_balances_redraw_balance,
t.value:record.account_balances.principal_balance::VARCHAR AS account_balances_principal_balance,
t.value:record.terms.interest_settings.interest_rate::VARCHAR AS terms_interest_settings_interest_rate,
t.value:record.transaction_details.transaction_channel_key::VARCHAR AS transaction_details_transaction_channel_key,
t.value:record.transaction_details.transaction_channel_id::VARCHAR AS transaction_details_transaction_channel_id,
t.value:record.fees[0].predefined_fee_key::VARCHAR AS fees_predefined_fee_key,
t.value:record.fees[0].name::VARCHAR AS fees_name,
t.value:record.fees[0].amount::VARCHAR AS fees_amount,
t.value:record.fees[0].tax_amount::VARCHAR AS fees_tax_amount,
t.value:record.fees[0].trigger::VARCHAR AS fees_trigger,
t.value:record.currency.code::VARCHAR AS currency_code,
t.value:record.adjustment_transaction_key::VARCHAR AS adjustment_transaction_key,
t.value:record.original_transaction_key::VARCHAR AS original_transaction_key,
t.value:time_extracted::TIMESTAMP_TZ(9) AS time_extracted,
CONVERT_TIMEZONE('America/Asuncion',creation_date) AS local_creation_date,
CONVERT_TIMEZONE('America/Asuncion',value_date) AS local_value_date
from @stg_mambu_loan_transactions_json S,
table(flatten(S.$1,'data')) t) LT
LEFT OUTER JOIN (SELECT 
                    t.value:record.encoded_key::VARCHAR AS ADJUSTMENT_TRANSACTION_KEY, 
                    t.value:record.id::VARCHAR AS ADJUSTMENT_TRANSACTION_ID 
                FROM @stg_mambu_loan_transactions_json S,
                    table(flatten(S.$1,'data')) t
                GROUP BY ADJUSTMENT_TRANSACTION_KEY, ADJUSTMENT_TRANSACTION_ID) ADJ ON LT.ADJUSTMENT_TRANSACTION_KEY = ADJ.ADJUSTMENT_TRANSACTION_KEY
LEFT OUTER JOIN (SELECT 
                    t.value:record.encoded_key::VARCHAR AS ORIGINAL_TRANSACTION_KEY, 
                    t.value:record.id::VARCHAR AS ORIGINAL_TRANSACTION_ID 
                FROM @stg_mambu_loan_transactions_json S,
                    table(flatten(S.$1,'data')) t
                GROUP BY ORIGINAL_TRANSACTION_KEY, ORIGINAL_TRANSACTION_ID) ORI ON LT.ORIGINAL_TRANSACTION_KEY = ORI.ORIGINAL_TRANSACTION_KEY);
GO
CREATE OR REPLACE VIEW INFORMATION_DELIVERY_PROD.MFS_TMP.MMB_USERS_VW as (
SELECT
t.value:record.last_name::VARCHAR AS last_name,
t.value:record.access.can_manage_entities_assigned_to_other_officers::VARCHAR AS access_can_manage_entities_assigned_to_other_officers,
t.value:record.access.mambu_access::BOOLEAN AS access_mambu_access,
t.value:record.access.administrator_access::BOOLEAN AS access_administrator_access,
t.value:record.access.api_access::BOOLEAN AS access_api_access,
t.value:record.access.credit_officer_access::BOOLEAN AS access_credit_officer_access,
t.value:record.access.can_manage_all_branches::BOOLEAN AS access_can_manage_all_branches,
t.value:record.access.support_access::BOOLEAN AS access_support_access,
t.value:record.access.teller_access::BOOLEAN AS access_teller_access,
t.value:record.notes::VARCHAR AS notes,
t.value:record.last_logged_in_date::TIMESTAMP_TZ(9) AS last_logged_in_date,
t.value:record.last_modified_date::TIMESTAMP_TZ(9) AS last_modified_date,
t.value:record.home_phone::VARCHAR AS home_phone,
t.value:record.language::VARCHAR AS language,
t.value:record.creation_date::TIMESTAMP_TZ(9) AS creation_date,
t.value:record.title::VARCHAR AS title,
t.value:record.assigned_branch_key::VARCHAR AS assigned_branch_key,
t.value:record.first_name::VARCHAR AS first_name,
t.value:record.mobile_phone::VARCHAR AS mobile_phone,
t.value:record.user_state::VARCHAR AS user_state,
t.value:record.two_factor_authentication::BOOLEAN AS two_factor_authentication,
t.value:record.encoded_key::VARCHAR AS encoded_key,
t.value:record.id::VARCHAR AS id,
t.value:record.email::VARCHAR AS email,
t.value:record.username::VARCHAR AS username,
t.value:record.access::VARCHAR AS access,
t.value:record.custom_fields::VARCHAR AS custom_fields,
t.value:record.role.encoded_key::VARCHAR AS role_encoded_key,
t.value:record.role.id::VARCHAR AS role_id,
t.value:time_extracted::TIMESTAMP_TZ(9) AS time_extracted
from @stg_mambu_users_json S,
table(flatten(S.$1,'data')) t
qualify row_number() over (partition by encoded_key order by TIME_EXTRACTED desc) = 1);